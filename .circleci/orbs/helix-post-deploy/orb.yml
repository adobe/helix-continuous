version: 2.1

description: |
  Runs post-deploy actions on Project Helix repos

executors:
    node8:
        docker:
            - image: circleci/node:8
commands:
    post-deploy:
        description: Runs post-deploy actions on Project Helix repos
        parameters:
            action_name:
                type: string
                description: The name of the deployed action
            newrelic_auth:
                type: env_var_name
                default: NEWRELIC_AUTH
                description: The admin's API key for your New Relic account (not the user API key!)
            newrelic_name:
                type: string
                description: The name to be used for the New Relic monitor, alert policy and notification channel
            newrelic_group_policy: 
                type: string
                description: A collective alert policy in New Relic to add the monitor to
            statuspage_auth:
                type: env_var_name
                default: STATUSPAGE_AUTH
                description: The API user key for your Statuspage account (this is the user API key)
            statuspage_page_id:
                type: env_var_name
                default: STATUSPAGE_PAGE_ID
                description: The ID of the page to add components to in Statuspage
            statuspage_name:
                type: string
                description: The name to be used for the Statuspage component
            statuspage_group:
                type: string
                description: The name of the component group in Statuspage to add the new component to
        steps:
            - run:
                name: Run post-deploy actions
                command: |
                    # statuspage automation
                    # TODO: actual shell script here
                    spName = "<< statuspage_name >>" || null
                    spGroup = "<< statuspage_group >>" || null
                    email = `node ./node_modules/.bin/statuspage setup --silent --name ${spName} --group ${spGroup}`
                    # new relic automation
                    nrName = "<< newrelic_name >>" || null
                    nrGroupPolicy = "<< newrelic_group_policy >>" || null
                    actionName = "<< action_name >>" || `node -e "console.log(require('./package.json').name.replace('@adobe/helix-', ''))"`
                    actionVersion = `node -e "console.log(require('./package.json').version.match(/^[0-9]+.[0-9]+/)[0])"`
                    url = "https://adobeioruntime.net/api/v1/web/helix/helix-services/${actionName}@v${actionVersion}/_status_check/healthcheck.json"
                    node ./node_modules/.bin/newrelic setup ${url} ${email} --name ${nrName} --group_policy ${nrGroupPolicy}
